# NIKKE 小游戏自动化辅助工具

> 一个使用 OCR 识别和 AI 求解算法自动完成 NIKKE 游戏内数字消除迷你游戏的辅助工具。目标是满分。

## ✨ 功能特性

- 🔍 **智能 OCR 识别**：使用 ddddocr 自动识别游戏棋盘上的数字
- 🧠 **高效求解算法**：采用 Beam Search 束搜索算法，配合 Numba JIT 加速
- 🎮 **自动操作**：模拟鼠标拖拽操作，全自动完成游戏
- 🔄 **两阶段求解**：
  - 第一阶段：约束模式，确保每步后棋盘理论可解
  - 第二阶段：洗牌后完全清除模式
- 📊 **多模式支持**：支持 10x16 和 9x15 两种棋盘规格
- 🔁 **循环模式**：可选开启循环模式，自动重复游戏

## 📋 系统要求

- **操作系统**：Windows
- **Python 版本**：Python 3.8+
- **游戏设置**：游戏需要在 **16:9** 比例下运行
- **权限**：需要以 **管理员模式** 运行程序

## 🚀 安装

1. **克隆或下载项目**

   ```bash
   git clone <repository-url>
   cd small_game_11
   ```

2. **创建虚拟环境（推荐）**

   ```bash
   python -m venv .venv
   .venv\Scripts\activate
   ```

3. **安装依赖**

   ```bash
   pip install -r requirements.txt
   ```

4. **可选：安装 Numba 以获得更好的性能**

   ```bash
   pip install numba
   ```

   > ⚠️ 如果没有安装 Numba，求解器仍可运行，但速度会明显变慢。

## 📖 使用方法

### 运行前准备

1. 确保游戏在 **16:9** 分辨率下运行
2. 建议在全屏模式下运行，或让游戏窗口尽量大
3. **重要**：先进入一次小游戏，暂停后【快速退出】，结算当次游戏后再执行程序
4. 以 **管理员模式** 启动命令行

### 启动程序

```bash
python main.py
```

### 操作流程

1. 程序启动后，选择游戏模式：
   - `1` - 10x16（默认）
   - `2` - 9x15

2. 选择是否启用循环模式（y/n）

3. 程序将自动：
   - 查找游戏窗口
   - 截取并识别棋盘
   - 计算最优解
   - 执行鼠标操作完成游戏

### 紧急停止

**将鼠标快速移动到屏幕左上角** 即可触发 PyAutoGUI 的故障保护机制，立即停止程序。

## 📁 项目结构

```
small_game_11/
├── main.py              # 程序入口
├── requirements.txt     # 依赖列表
├── README.md            # 项目说明文档
└── src/
    ├── __init__.py
    ├── automator.py     # 游戏自动化控制器（主流程）
    ├── config.py        # 游戏配置（坐标、缩放参数）
    ├── ocr.py           # OCR 数字识别模块
    ├── solver.py        # 核心求解算法（Beam Search）
    └── window.py        # Windows 窗口管理
```

### 模块说明

| 模块 | 描述 |
|------|------|
| `automator.py` | 主控制器，协调 OCR、求解器和鼠标操作 |
| `solver.py` | 高性能求解器，使用 Numba 加速的 Beam Search 算法，核心算法引用自 [sum10_Nikke](https://github.com/Small-tailqwq/sum10_Nikke) 并进行了部分性能优化 ，根据原作者要求，此文件内部的代码禁止任何商业使用。|
| `config.py` | 游戏参数配置，支持不同分辨率的自动缩放 |
| `ocr.py` | 基于 ddddocr 的数字识别封装 |
| `window.py` | Windows 窗口句柄查找与坐标获取 |

## ⚙️ 配置说明

### 时间限制

在 `src/solver.py` 文件顶部可以调整求解的时间限制：

```python
TIME_LIMIT_PHASE1 = 25.0  # 第一阶段（约束模式）时间限制（秒）
TIME_LIMIT_PHASE2 = 35.0  # 第二阶段（完全清除）时间限制（秒）
```

### 游戏模式配置

在 `src/config.py` 中定义了两种棋盘模式：

- **模式 1 (10x16)**：10 列 × 16 行
- **模式 2 (9x15)**：9 列 × 15 行

配置参数基于 4K (3840×2160) 分辨率校准，程序会自动根据实际窗口尺寸进行缩放。

## 🧪 工作原理

### 求解算法

1. **Beam Search 束搜索**
   - 使用启发式评估函数对状态进行评分
   - 保留最优的 K 个候选状态继续搜索
   - 支持多线程并行搜索

2. **两阶段策略**
   - **第一阶段**：约束模式，每一步都验证棋盘的理论可解性
   - **按 W 键**：触发游戏内洗牌
   - **第二阶段**：完全清除模式，追求满分

3. **Numba JIT 加速**
   - 核心计算函数使用 Numba 编译为机器码
   - 数量级性能提升

### 可解性验证

基于数论的验证逻辑：

- 所有数字总和必须能被 10 整除
- 大数必须有足够的小数来配对（9 需要 1，8 需要 2，以此类推）

## 🔧 故障排除

### 常见问题

1. **无法操作游戏窗口**
   - 确保以管理员模式运行程序
   - 检查游戏是否在前台运行

2. **识别不准确**
   - 确保游戏在 16:9 比例下运行
   - 尝试调大游戏窗口

3. **求解速度慢**
   - 安装 Numba：`pip install numba`
   - 程序首次运行时 Numba 需要编译，后续会使用缓存

4. **找不到游戏窗口**
   - 确保游戏已启动并可见
   - 检查窗口标题是否正确

## 📄 依赖项

- **ddddocr** - OCR 识别引擎
- **pyautogui** - 鼠标键盘自动化
- **numpy** - 数值计算
- **opencv-python** - 图像处理
- **Pillow** - 图像捕获
- **numba** (可选) - JIT 编译加速

## ⚠️ 免责声明

本工具仅供学习和研究使用。使用本工具可能违反游戏的服务条款，请自行承担使用风险。

## 📝 License

MIT License

(`solver.py`内部核心算法修改自 [sum10_Nikke](https://github.com/Small-tailqwq/sum10_Nikke)，根据原作者要求，此文件内部的代码禁止任何商业使用。)